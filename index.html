
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>BoardingGate - Oposiciones</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons (VERSIÓN REACT CORREGIDA) -->
    <script src="https://unpkg.com/lucide-react@0.294.0/dist/umd/lucide-react.min.js"></script>
    
    <style>
      body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #e5e5e5; overflow: hidden; height: 100vh; }
      .font-display { font-family: 'Orbitron', sans-serif; }
      
      /* Scrollbar */
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: #1a1a1a; }
      ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #444; }
      
      .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; background: rgba(59, 130, 246, 0.1); }
      .tab-inactive { border-bottom: 2px solid transparent; color: #94a3b8; }
      .tab-inactive:hover { color: #e2e8f0; background: rgba(255, 255, 255, 0.05); }

      .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
      
      /* Animaciones */
      @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
      .animate-pulse-error { animation: pulse-red 1s; }
      
      .fade-in { animation: fadeIn 0.3s ease-in-out; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <!-- Contenedor para mostrar errores fatales si ocurren -->
    <div id="error-display" style="display:none; color: #ff6b6b; padding: 20px; font-family: monospace; background: #220000; border: 1px solid red; margin: 20px;"></div>
    
    <div id="root"></div>

    <!-- Script de captura de errores -->
    <script>
      window.onerror = function(message, source, lineno, colno, error) {
        document.getElementById('error-display').style.display = 'block';
        document.getElementById('error-display').innerHTML = '<strong>Error Crítico:</strong><br>' + message + '<br><br>Intenta recargar la página.';
      };
    </script>

    <script type="text/babel">
      const { useState, useEffect, useMemo, useRef } = React;
      const { createRoot } = ReactDOM;
      
      // CORRECCIÓN: Usamos lucideReact en lugar de lucide
      const { Clock, Grid, Save, Trash2, Plus, AlertTriangle, CheckCircle, XCircle, Settings, BookOpen, BarChart3, HelpCircle, Play, SkipForward, ArrowLeft, ArrowRight, Eye, EyeOff, BrainCircuit, ExternalLink, RefreshCw } = lucideReact;

      // --- UTILS ---
      const usePersistentState = (key, initialValue) => {
        const [state, setState] = useState(() => {
            try {
                const item = window.localStorage.getItem(key);
                return item ? JSON.parse(item) : initialValue;
            } catch (error) { return initialValue; }
        });
        useEffect(() => {
            window.localStorage.setItem(key, JSON.stringify(state));
        }, [key, state]);
        return [state, setState];
      };

      const formatTime = (seconds) => {
          const h = Math.floor(seconds / 3600);
          const m = Math.floor((seconds % 3600) / 60);
          const s = seconds % 60;
          return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
      };

      // --- GEMINI API INTEGRATION ---
      const generateQuestionsWithGemini = async (apiKey, subject, amount) => {
          if (!apiKey) throw new Error("Falta la API Key. Ve a Configuración.");

          const prompt = `
            Actúa como un experto examinador de oposiciones para: "${subject.type}".
            Materia específica: "${subject.name}".
            
            Distribución de temas requerida:
            ${subject.topics.map(t => `- ${t.name} (${t.pct}%)`).join('\n')}
            
            Genera un examen de ${amount} preguntas tipo test.
            Formato de salida: ÚNICAMENTE UN ARRAY JSON VÁLIDO. Sin markdown, sin texto antes ni después.
            Estructura de cada objeto en el array:
            {
              "id": (número incremental),
              "question": "Texto de la pregunta (profesional y técnica)",
              "options": ["Opción A", "Opción B", "Opción C", "Opción D"],
              "correct": (índice numérico de la opción correcta 0-3),
              "explanation": "Explicación detallada de por qué es la correcta y citando normativa si aplica."
            }
            
            Las preguntas deben ser difíciles, no repetidas y estrictamente relacionadas con la materia.
          `;

          try {
              const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                      contents: [{ parts: [{ text: prompt }] }],
                      generationConfig: {
                          temperature: 0.7,
                          maxOutputTokens: 8192, 
                          responseMimeType: "application/json"
                      }
                  })
              });

              if (!response.ok) {
                  const errData = await response.json();
                  throw new Error(errData.error?.message || "Error conectando con Gemini");
              }

              const data = await response.json();
              if(!data.candidates || !data.candidates[0].content) throw new Error("La IA no devolvió contenido.");
              
              const textResponse = data.candidates[0].content.parts[0].text;
              return JSON.parse(textResponse); 
          } catch (error) {
              console.error("Gemini Error:", error);
              throw error;
          }
      };

      // --- COMPONENTES ---

      // 1. PESTAÑA CONFIGURACIÓN
      const SettingsTab = () => {
          const [apiKey, setApiKey] = usePersistentState('gemini_api_key', '');
          const [showKey, setShowKey] = useState(false);

          return (
              <div className="h-full p-6 flex flex-col items-center justify-center fade-in">
                  <div className="max-w-2xl w-full bg-slate-900/80 border border-slate-800 rounded-2xl p-8 shadow-2xl">
                      <div className="flex items-center gap-4 mb-6 border-b border-slate-700 pb-4">
                          <div className="p-3 bg-purple-500/20 rounded-xl text-purple-400">
                              <BrainCircuit size={32} />
                          </div>
                          <div>
                              <h2 className="text-2xl font-bold text-white">Configuración IA</h2>
                              <p className="text-slate-400 text-sm">Motor de generación de exámenes</p>
                          </div>
                      </div>

                      <div className="space-y-6">
                          <div>
                              <label className="block text-sm font-bold text-slate-300 mb-2">Google Gemini API Key</label>
                              <div className="relative">
                                  <input 
                                      type={showKey ? "text" : "password"} 
                                      value={apiKey}
                                      onChange={(e) => setApiKey(e.target.value)}
                                      placeholder="Pega tu clave aquí (sk-...)"
                                      className="w-full bg-black/50 border border-slate-600 rounded-xl p-4 pr-12 text-white focus:border-purple-500 focus:outline-none font-mono"
                                  />
                                  <button 
                                      onClick={() => setShowKey(!showKey)}
                                      className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-slate-300"
                                  >
                                      {showKey ? <EyeOff size={20}/> : <Eye size={20}/>}
                                  </button>
                              </div>
                              <p className="text-xs text-slate-500 mt-2">La clave se guarda localmente en tu navegador. Nunca se comparte.</p>
                          </div>

                          <div className="bg-blue-900/20 border border-blue-500/30 rounded-xl p-4">
                              <h4 className="text-blue-400 font-bold text-sm mb-2 flex items-center gap-2">
                                  <HelpCircle size={16}/> ¿Cómo obtener la API Key GRATIS?
                              </h4>
                              <ol className="text-sm text-slate-300 space-y-2 list-decimal pl-4 mb-4">
                                  <li>Accede a <strong>Google AI Studio</strong> con tu cuenta de Google.</li>
                                  <li>Haz clic en el botón <strong>"Get API key"</strong>.</li>
                                  <li>Crea una clave en un proyecto nuevo.</li>
                                  <li>Copia el código y pégalo arriba.</li>
                              </ol>
                              <a 
                                  href="https://aistudio.google.com/app/apikey" 
                                  target="_blank"
                                  className="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-sm font-bold transition-colors"
                              >
                                  <ExternalLink size={16}/> Ir a Google AI Studio
                              </a>
                          </div>
                      </div>
                  </div>
              </div>
          );
      };

      // 2. PESTAÑA MATERIAS
      const SubjectsTab = ({ subjects, setSubjects, activeSubjectId, setActiveSubjectId }) => {
          const [isEditing, setIsEditing] = useState(false);
          const [editForm, setEditForm] = useState(null);

          const defaultSubject = {
              id: null, name: '', type: '', qCount: 10, qReserve: 2, cutOffPct: 50, 
              timeMinutes: 20,
              pointsHit: 3, pointsMiss: -1, pointsSkip: 0, optionsCount: 4,
              topics: [{ name: 'Temario General', pct: 100 }]
          };

          const handleNew = () => { setEditForm({ ...defaultSubject, id: Date.now() }); setIsEditing(true); };
          const handleEdit = (sub) => { setEditForm({ ...sub }); setIsEditing(true); };
          
          const handleSave = () => {
              if(!editForm.name) return alert("El nombre es obligatorio");
              setSubjects(prev => {
                  const exists = prev.find(s => s.id === editForm.id);
                  return exists ? prev.map(s => s.id === editForm.id ? editForm : s) : [...prev, editForm];
              });
              if (!activeSubjectId) setActiveSubjectId(editForm.id);
              setIsEditing(false);
          };

          const handleDelete = (id) => {
              if (confirm("¿Borrar materia?")) {
                  setSubjects(prev => prev.filter(s => s.id !== id));
                  if (activeSubjectId === id) setActiveSubjectId(null);
              }
          };

          const handleTopicChange = (idx, field, val) => {
              const newTopics = [...editForm.topics];
              newTopics[idx][field] = val;
              setEditForm({ ...editForm, topics: newTopics });
          };

          if (isEditing) {
              return (
                  <div className="h-full flex flex-col p-4 overflow-y-auto fade-in scrollbar-thin">
                      <div className="max-w-4xl mx-auto w-full pb-20">
                          <h3 className="text-xl font-display font-bold text-white mb-6 border-b border-slate-700 pb-2 flex items-center gap-2">
                              <Settings size={24} className="text-blue-500"/> {editForm.name ? 'Editar Materia' : 'Nueva Materia'}
                          </h3>
                          
                          <div className="glass-panel p-6 rounded-xl mb-6 space-y-4">
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                  <div><label className="text-xs font-bold text-slate-400 block mb-1">Materia (Nombre)</label><input type="text" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white focus:border-blue-500 outline-none" value={editForm.name} onChange={e => setEditForm({...editForm, name: e.target.value})} /></div>
                                  <div><label className="text-xs font-bold text-slate-400 block mb-1">Tipo Oposición</label><input type="text" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white focus:border-blue-500 outline-none" value={editForm.type} onChange={e => setEditForm({...editForm, type: e.target.value})} /></div>
                              </div>
                              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                  <div><label className="text-xs font-bold text-slate-400 block mb-1">Preguntas (IA)</label><input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-right" value={editForm.qCount} onChange={e => setEditForm({...editForm, qCount: parseInt(e.target.value)})} /></div>
                                  <div><label className="text-xs font-bold text-slate-400 block mb-1">Reserva</label><input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-right" value={editForm.qReserve} onChange={e => setEditForm({...editForm, qReserve: parseInt(e.target.value)})} /></div>
                                  <div><label className="text-xs font-bold text-slate-400 block mb-1">Corte %</label><input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-right" value={editForm.cutOffPct} onChange={e => setEditForm({...editForm, cutOffPct: parseFloat(e.target.value)})} /></div>
                                  <div><label className="text-xs font-bold text-slate-400 block mb-1">Tiempo (min)</label><input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-right" value={editForm.timeMinutes} onChange={e => setEditForm({...editForm, timeMinutes: parseInt(e.target.value)})} /></div>
                              </div>
                          </div>

                          <div className="glass-panel p-6 rounded-xl mb-6">
                              <h4 className="text-sm font-bold text-blue-400 mb-3 uppercase tracking-wider">Baremo de Puntuación</h4>
                              <div className="grid grid-cols-4 gap-4">
                                  <div><label className="text-xs font-bold text-green-400 block mb-1">Acierto</label><input type="number" step="0.1" className="w-full bg-slate-900 border border-green-900/50 rounded p-2 text-green-400 font-bold text-right" value={editForm.pointsHit} onChange={e => setEditForm({...editForm, pointsHit: parseFloat(e.target.value)})} /></div>
                                  <div><label className="text-xs font-bold text-red-400 block mb-1">Fallo</label><input type="number" step="0.1" className="w-full bg-slate-900 border border-red-900/50 rounded p-2 text-red-400 font-bold text-right" value={editForm.pointsMiss} onChange={e => setEditForm({...editForm, pointsMiss: parseFloat(e.target.value)})} /></div>
                                  <div><label className="text-xs font-bold text-slate-400 block mb-1">Omisión</label><input type="number" step="0.1" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-right" value={editForm.pointsSkip} onChange={e => setEditForm({...editForm, pointsSkip: parseFloat(e.target.value)})} /></div>
                                  <div><label className="text-xs font-bold text-slate-400 block mb-1">Opciones</label><input type="number" className="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-right" value={editForm.optionsCount} onChange={e => setEditForm({...editForm, optionsCount: parseInt(e.target.value)})} /></div>
                              </div>
                          </div>

                          <div className="glass-panel p-6 rounded-xl">
                              <div className="flex justify-between items-center mb-4">
                                  <label className="text-sm font-bold text-slate-300 uppercase">Distribución Temática</label>
                                  <button onClick={() => setEditForm({...editForm, topics: [...editForm.topics, {name: '', pct: 0}]})} className="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1 rounded font-bold">+ Añadir Tema</button>
                              </div>
                              {editForm.topics.map((t, idx) => (
                                  <div key={idx} className="flex gap-2 mb-2 items-center">
                                      <input type="text" placeholder="Ej: Constitución Española" className="flex-1 bg-slate-900 border border-slate-600 rounded p-2 text-sm text-white" value={t.name} onChange={e => handleTopicChange(idx, 'name', e.target.value)} />
                                      <input type="number" placeholder="%" className="w-20 bg-slate-900 border border-slate-600 rounded p-2 text-sm text-white text-right" value={t.pct} onChange={e => handleTopicChange(idx, 'pct', parseFloat(e.target.value))} />
                                      <button onClick={() => {
                                          const newT = editForm.topics.filter((_, i) => i !== idx);
                                          setEditForm({...editForm, topics: newT});
                                      }} className="text-red-400 hover:text-red-300 p-2"><Trash2 size={18} /></button>
                                  </div>
                              ))}
                          </div>

                          <div className="flex gap-4 pt-6 mt-4 border-t border-slate-700">
                              <button onClick={() => setIsEditing(false)} className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-slate-300 font-bold transition-colors">Cancelar</button>
                              <button onClick={handleSave} className="flex-1 py-3 bg-blue-600 hover:bg-blue-500 rounded-xl text-white font-bold flex items-center justify-center gap-2 shadow-lg shadow-blue-900/20 transition-colors"><Save size={18}/> Guardar Configuración</button>
                          </div>
                      </div>
                  </div>
              );
          }

          return (
              <div className="h-full flex flex-col p-6 fade-in">
                  <div className="flex justify-between items-center mb-6">
                      <div>
                          <h3 className="text-2xl font-display font-bold text-white">Materias</h3>
                          <p className="text-slate-400 text-xs mt-1">Gestiona los temarios de tus oposiciones</p>
                      </div>
                      <button onClick={handleNew} className="bg-green-600 hover:bg-green-500 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 shadow-lg shadow-green-900/20 transition-colors"><Plus size={20}/> Nueva Materia</button>
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 overflow-y-auto pb-20">
                      {subjects.map(sub => (
                          <div key={sub.id} 
                               onClick={() => setActiveSubjectId(sub.id)}
                               className={`relative p-6 rounded-2xl border-2 transition-all cursor-pointer group ${activeSubjectId === sub.id ? 'bg-blue-900/20 border-blue-500 shadow-[0_0_20px_rgba(59,130,246,0.2)]' : 'bg-slate-900/50 border-slate-700 hover:border-slate-500'}`}>
                              
                              <div className="flex justify-between items-start mb-4">
                                  <div className={`p-3 rounded-xl ${activeSubjectId === sub.id ? 'bg-blue-500 text-white' : 'bg-slate-800 text-slate-400'}`}>
                                      <BookOpen size={24} />
                                  </div>
                                  {activeSubjectId === sub.id && <div className="bg-blue-500 text-white text-[10px] font-bold px-2 py-1 rounded uppercase">Seleccionada</div>}
                              </div>

                              <h4 className="text-lg font-bold text-white mb-1 truncate">{sub.name}</h4>
                              <p className="text-xs text-slate-400 mb-4 h-8 overflow-hidden">{sub.type}</p>

                              <div className="grid grid-cols-2 gap-2 text-xs text-slate-300 mb-4 bg-black/20 p-2 rounded-lg">
                                  <div>Preguntas: <span className="font-bold text-white">{sub.qCount}</span></div>
                                  <div>Corte: <span className="font-bold text-white">{sub.cutOffPct}%</span></div>
                                  <div>Tiempo: <span className="font-bold text-white">{sub.timeMinutes}m</span></div>
                                  <div>Temas: <span className="font-bold text-white">{sub.topics.length}</span></div>
                              </div>

                              <div className="flex justify-end gap-2 opacity-50 group-hover:opacity-100 transition-opacity">
                                  <button onClick={(e) => { e.stopPropagation(); handleEdit(sub); }} className="p-2 hover:bg-slate-700 rounded text-blue-400"><Settings size={18}/></button>
                                  <button onClick={(e) => { e.stopPropagation(); handleDelete(sub.id); }} className="p-2 hover:bg-slate-700 rounded text-red-400"><Trash2 size={18}/></button>
                              </div>
                          </div>
                      ))}
                      {subjects.length === 0 && (
                          <div className="col-span-full flex flex-col items-center justify-center py-20 text-slate-500 border-2 border-dashed border-slate-800 rounded-2xl">
                              <BookOpen size={48} className="mb-4 opacity-50"/>
                              <p>No hay materias creadas. Crea una para empezar.</p>
                          </div>
                      )}
                  </div>
              </div>
          );
      };

      // 3. PESTAÑA EXAMEN (CORE)
      const ExamTab = ({ activeSubject, onSaveResult }) => {
          const [status, setStatus] = useState('idle'); // idle, loading, active, finished
          const [questions, setQuestions] = useState([]);
          const [answers, setAnswers] = useState({}); // { qId: optionIndex or -1 (skip) }
          const [currentIndex, setCurrentIndex] = useState(0);
          const [timeLeft, setTimeLeft] = useState(0);
          const [autoNext, setAutoNext] = useState(false);
          const [showGrid, setShowGrid] = useState(false);
          const [loadingMsg, setLoadingMsg] = useState('');
          const [error, setError] = useState(null);

          // Cargar API Key
          const [apiKey] = usePersistentState('gemini_api_key', '');

          // Timer
          useEffect(() => {
              let timer;
              if (status === 'active' && timeLeft > 0) {
                  timer = setInterval(() => setTimeLeft(p => p - 1), 1000);
              } else if (timeLeft === 0 && status === 'active') {
                  finishExam();
              }
              return () => clearInterval(timer);
          }, [status, timeLeft]);

          const startExam = async () => {
              if (!activeSubject) return alert("Selecciona una materia primero.");
              if (!apiKey) return alert("Falta la API Key en Configuración.");

              setStatus('loading');
              setLoadingMsg('Conectando con IA...');
              setError(null);
              
              try {
                  const qCount = Math.min(activeSubject.qCount, 50); // Límite seguridad
                  setLoadingMsg(`Generando ${qCount} preguntas únicas...`);
                  
                  const generated = await generateQuestionsWithGemini(apiKey, activeSubject, qCount);
                  
                  if (!Array.isArray(generated) || generated.length === 0) throw new Error("La IA no devolvió preguntas válidas.");

                  setQuestions(generated);
                  setAnswers({});
                  setCurrentIndex(0);
                  setTimeLeft(activeSubject.timeMinutes * 60);
                  setStatus('active');
              } catch (e) {
                  setError(e.message);
                  setStatus('idle');
              }
          };

          const handleAnswer = (optionIdx) => {
              setAnswers(prev => ({ ...prev, [currentIndex]: optionIdx }));
              if (autoNext && currentIndex < questions.length - 1) {
                  setTimeout(() => setCurrentIndex(p => p + 1), 300);
              }
          };

          const finishExam = () => {
              setStatus('finished');
              const stats = calculateStats();
              onSaveResult({
                  date: new Date().toISOString(),
                  subjectId: activeSubject.id,
                  subjectName: activeSubject.name,
                  score: stats.points,
                  maxScore: stats.maxPoints,
                  percentage: stats.percentage,
                  hits: stats.hits,
                  misses: stats.misses,
                  skips: stats.skips,
                  total: questions.length
              });
          };

          const calculateStats = () => {
              let hits = 0, misses = 0, skips = 0;
              questions.forEach((q, idx) => {
                  const ans = answers[idx];
                  if (ans === undefined) skips++;
                  else if (ans === -1) skips++; 
                  else if (ans === q.correct) hits++;
                  else misses++;
              });

              const points = (hits * activeSubject.pointsHit) + (misses * activeSubject.pointsMiss) + (skips * activeSubject.pointsSkip);
              const maxPoints = questions.length * activeSubject.pointsHit; 
              const percentage = maxPoints > 0 ? (points / maxPoints) * 100 : 0;
              
              return { hits, misses, skips, points, maxPoints, percentage };
          };

          const stats = useMemo(() => status !== 'idle' ? calculateStats() : {}, [answers, questions]);

          // --- VISTA: IDLE / ERROR ---
          if (status === 'idle') {
              return (
                  <div className="h-full flex flex-col items-center justify-center p-6 fade-in text-center">
                      {!activeSubject ? (
                          <div className="text-slate-500">Selecciona una materia en la pestaña "Materias"</div>
                      ) : (
                          <div className="max-w-lg w-full bg-slate-900/80 border border-slate-800 p-8 rounded-2xl shadow-2xl">
                              <h2 className="text-3xl font-display font-bold text-white mb-2">{activeSubject.name}</h2>
                              <p className="text-slate-400 mb-8">{activeSubject.type}</p>
                              
                              <div className="grid grid-cols-2 gap-4 mb-8 text-sm">
                                  <div className="bg-slate-800 p-3 rounded">Preguntas: <strong className="text-white">{activeSubject.qCount}</strong></div>
                                  <div className="bg-slate-800 p-3 rounded">Tiempo: <strong className="text-white">{activeSubject.timeMinutes}m</strong></div>
                              </div>

                              {error && (
                                  <div className="bg-red-900/20 border border-red-500/50 p-4 rounded-xl mb-6 text-red-200 text-sm flex items-center gap-3 animate-pulse-error">
                                      <AlertTriangle size={24}/>
                                      <div className="text-left">{error}</div>
                                  </div>
                              )}

                              <button onClick={startExam} className="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-900/30 transition-all transform hover:scale-105 flex items-center justify-center gap-3">
                                  <Play size={24}/> COMENZAR SIMULACRO
                              </button>
                          </div>
                      )}
                  </div>
              );
          }

          // --- VISTA: LOADING ---
          if (status === 'loading') {
              return (
                  <div className="h-full flex flex-col items-center justify-center p-6 fade-in">
                      <div className="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500 mb-6"></div>
                      <h3 className="text-xl font-bold text-white animate-pulse">{loadingMsg}</h3>
                      <p className="text-slate-500 text-sm mt-2">Creando contenido único con IA...</p>
                  </div>
              );
          }

          const currentQ = questions[currentIndex];
          const currentAns = answers[currentIndex]; 
          const isAnswered = currentAns !== undefined;
          const isWrong = isAnswered && currentAns !== -1 && currentAns !== currentQ.correct;
          const isSkipped = currentAns === -1;

          // Progreso Visual
          const maxPossibleScore = stats.maxPoints - (stats.misses * (activeSubject.pointsHit + Math.abs(activeSubject.pointsMiss))) - (stats.skips * activeSubject.pointsHit); 
          const pctSecured = (stats.points / stats.maxPoints) * 100;
          const pctLost = 100 - (maxPossibleScore / stats.maxPoints) * 100;

          // Desviación tiempo
          const timePerQ = activeSubject.timeMinutes * 60 / questions.length;
          const idealElapsed = (currentIndex) * timePerQ;
          const actualElapsed = (activeSubject.timeMinutes * 60) - timeLeft;
          const timeDiff = idealElapsed - actualElapsed; 

          return (
              <div className="h-full flex flex-col overflow-hidden bg-[#0a0a0a]">
                  {/* HEADER - DASHBOARD */}
                  <div className="bg-slate-900 border-b border-slate-800 p-2 md:p-4 shrink-0">
                      <div className="flex justify-between items-end mb-2">
                          <div className="flex items-center gap-4">
                              <div className="text-center">
                                  <div className="text-2xl font-mono font-bold text-white leading-none">{formatTime(timeLeft)}</div>
                                  <div className={`text-[10px] font-bold mt-1 ${timeDiff >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                      {timeDiff >= 0 ? '+' : ''}{Math.round(timeDiff)}s (Desv)
                                  </div>
                              </div>
                              <div className="hidden md:block">
                                  <div className="text-xs text-slate-400 font-bold uppercase">{activeSubject.name}</div>
                                  <div className="text-[10px] text-slate-500">Pregunta {currentIndex + 1} de {questions.length}</div>
                              </div>
                          </div>

                          <div className="flex flex-col items-end">
                              <div className="text-3xl font-display font-bold text-white leading-none">
                                  {stats.points.toFixed(1)} <span className="text-xs text-slate-500 font-sans">pts</span>
                              </div>
                              <div className="text-[10px] font-bold text-slate-400">
                                  Corte: <span className="text-blue-400">{activeSubject.cutOffPct}%</span>
                              </div>
                          </div>
                      </div>

                      {/* BARRA PROGRESO DUAL */}
                      <div className="relative h-4 bg-slate-800 rounded-full overflow-hidden border border-slate-700 w-full">
                          <div className="absolute top-0 bottom-0 w-0.5 bg-white z-20 opacity-50" style={{left: `${activeSubject.cutOffPct}%`}}></div>
                          <div className="absolute top-0 left-0 h-full bg-gradient-to-r from-green-600 to-green-400 transition-all duration-500" style={{width: `${Math.max(0, pctSecured)}%`}}></div>
                          <div className="absolute top-0 right-0 h-full bg-gradient-to-l from-red-600 to-red-400 transition-all duration-500" style={{width: `${Math.max(0, pctLost)}%`}}></div>
                      </div>
                      
                      <div className="flex justify-between text-[9px] text-slate-500 font-bold mt-1 uppercase px-1">
                          <span>Aciertos: {stats.hits}</span>
                          <span>Fallos: {stats.misses}</span>
                          <span>Omitidas: {stats.skips}</span>
                      </div>
                  </div>

                  {/* BODY */}
                  <div className="flex-1 flex overflow-hidden relative">
                      
                      {/* ZONA PREGUNTA */}
                      <div className="flex-1 flex flex-col p-4 md:p-8 overflow-y-auto">
                          <div className="max-w-4xl mx-auto w-full">
                              <div className="mb-6">
                                  <span className="bg-blue-900/30 text-blue-300 text-xs font-bold px-2 py-1 rounded border border-blue-500/30 mb-2 inline-block">Pregunta {currentIndex + 1}</span>
                                  <h2 className="text-xl md:text-2xl font-bold text-white leading-snug">{currentQ.question}</h2>
                              </div>

                              <div className="grid grid-cols-1 gap-3">
                                  {currentQ.options.map((opt, idx) => {
                                      let btnClass = "bg-slate-800 border-slate-700 hover:bg-slate-700 text-slate-300";
                                      if (isAnswered) {
                                          if (idx === currentQ.correct) btnClass = "bg-green-900/40 border-green-500 text-green-200";
                                          else if (currentAns === idx) btnClass = "bg-red-900/40 border-red-500 text-red-200";
                                          else btnClass = "bg-slate-800/50 border-slate-700 text-slate-500 opacity-50";
                                      }

                                      return (
                                          <button 
                                              key={idx}
                                              disabled={isAnswered || status === 'finished'}
                                              onClick={() => handleAnswer(idx)}
                                              className={`text-left p-4 rounded-xl border-2 transition-all font-medium text-base md:text-lg flex items-start gap-3 ${btnClass}`}
                                          >
                                              <div className="shrink-0 w-6 h-6 rounded-full border border-current flex items-center justify-center text-xs font-bold mt-0.5">
                                                  {String.fromCharCode(65+idx)}
                                              </div>
                                              <span>{opt}</span>
                                          </button>
                                      );
                                  })}
                              </div>

                              {/* CONTROLES BAJOS */}
                              <div className="mt-8 flex flex-wrap items-center justify-between gap-4">
                                  <div className="flex gap-2">
                                      <button 
                                          disabled={isAnswered || status === 'finished'}
                                          onClick={() => handleAnswer(-1)}
                                          className="px-4 py-2 bg-slate-800 hover:bg-slate-700 text-slate-400 rounded-lg font-bold text-sm transition-colors border border-slate-700"
                                      >
                                          Omitir
                                      </button>
                                      <label className="flex items-center gap-2 cursor-pointer bg-slate-900 px-3 py-2 rounded-lg border border-slate-800">
                                          <input type="checkbox" checked={autoNext} onChange={e => setAutoNext(e.target.checked)} className="accent-blue-500" />
                                          <span className="text-xs text-slate-400 font-bold">Auto-saltar</span>
                                      </label>
                                  </div>
                                  
                                  <div className="flex gap-2">
                                      <button onClick={() => setCurrentIndex(p => Math.max(0, p - 1))} className="p-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-white"><ArrowLeft size={20}/></button>
                                      <button onClick={() => setCurrentIndex(p => Math.min(questions.length - 1, p + 1))} className="p-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-white"><ArrowRight size={20}/></button>
                                      <button onClick={() => setShowGrid(true)} className="p-3 bg-slate-800 hover:bg-slate-700 rounded-lg text-blue-400"><Grid size={20}/></button>
                                  </div>
                              </div>
                          </div>
                      </div>

                      {/* PANEL LATERAL FEEDBACK */}
                      {(isWrong || isSkipped) && isAnswered && (
                          <div className="w-80 bg-slate-900 border-l border-slate-700 p-6 overflow-y-auto shrink-0 hidden lg:block shadow-2xl animate-fade-in-right">
                              <h4 className="text-red-400 font-bold uppercase text-sm mb-4 flex items-center gap-2">
                                  <XCircle size={18}/> {isSkipped ? 'Pregunta Omitida' : 'Respuesta Incorrecta'}
                              </h4>
                              <div className="text-sm text-white font-bold mb-2">Respuesta Correcta:</div>
                              <div className="bg-green-900/20 border border-green-500/30 p-3 rounded-lg text-green-200 text-sm mb-6">
                                  {currentQ.options[currentQ.correct]}
                              </div>
                              <div className="text-sm text-white font-bold mb-2">Explicación Técnica:</div>
                              <div className="text-slate-400 text-sm leading-relaxed bg-slate-800/50 p-3 rounded border border-slate-700">
                                  {currentQ.explanation}
                              </div>
                          </div>
                      )}
                  </div>

                  {/* MODAL GRID */}
                  {showGrid && (
                      <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setShowGrid(false)}>
                          <div className="bg-slate-900 border border-slate-700 rounded-2xl p-6 max-w-3xl w-full max-h-[80vh] flex flex-col shadow-2xl" onClick={e => e.stopPropagation()}>
                              <div className="flex justify-between items-center mb-4">
                                  <h3 className="text-xl font-bold text-white">Mapa de Preguntas</h3>
                                  <button onClick={() => setShowGrid(false)} className="text-slate-400 hover:text-white"><XCircle/></button>
                              </div>
                              <div className="flex-1 overflow-y-auto grid grid-cols-5 sm:grid-cols-8 md:grid-cols-10 gap-2">
                                  {questions.map((q, i) => {
                                      const ans = answers[i];
                                      let bg = "bg-slate-800 text-slate-500 border-slate-700";
                                      if (ans !== undefined) {
                                          if (ans === -1) bg = "bg-blue-900/40 text-blue-400 border-blue-500/50";
                                          else if (ans === q.correct) bg = "bg-green-900/40 text-green-400 border-green-500/50";
                                          else bg = "bg-red-900/40 text-red-400 border-red-500/50";
                                      }
                                      if (i === currentIndex) bg += " ring-2 ring-white";
                                      
                                      return (
                                          <button key={i} onClick={() => { setCurrentIndex(i); setShowGrid(false); }} className={`aspect-square rounded border font-bold text-sm flex items-center justify-center transition-all ${bg}`}>
                                              {i + 1}
                                          </button>
                                      )
                                  })}
                              </div>
                              <div className="mt-6 pt-4 border-t border-slate-700 flex justify-between items-center">
                                  <div className="flex gap-4 text-xs font-bold uppercase">
                                      <span className="text-green-400">● Acierto</span>
                                      <span className="text-red-400">● Fallo</span>
                                      <span className="text-blue-400">● Omitida</span>
                                      <span className="text-slate-500">● Pendiente</span>
                                  </div>
                                  <button onClick={finishExam} className="bg-red-600 hover:bg-red-500 text-white px-6 py-2 rounded-lg font-bold shadow-lg">Terminar Examen</button>
                              </div>
                          </div>
                      </div>
                  )}
              </div>
          );
      };

      // 4. PESTAÑA HISTÓRICO
      const HistoryTab = ({ results, onClear }) => {
          const stats = useMemo(() => {
              if (results.length === 0) return null;
              const total = results.length;
              const avgScore = results.reduce((acc, r) => acc + r.score, 0) / total;
              const avgPct = results.reduce((acc, r) => acc + r.percentage, 0) / total;
              return { total, avgScore, avgPct };
          }, [results]);

          return (
              <div className="h-full flex flex-col p-6 fade-in overflow-hidden">
                  <div className="flex justify-between items-center mb-6 shrink-0">
                      <h3 className="text-2xl font-display font-bold text-white">Historial de Resultados</h3>
                      <button onClick={onClear} className="text-red-400 hover:text-red-300 flex items-center gap-2 text-sm font-bold"><Trash2 size={16}/> Limpiar Historial</button>
                  </div>

                  {stats && (
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6 shrink-0">
                          <div className="glass-panel p-4 rounded-xl flex items-center gap-4">
                              <div className="p-3 bg-blue-500/20 rounded-full text-blue-400"><BookOpen/></div>
                              <div><div className="text-2xl font-bold text-white">{stats.total}</div><div className="text-xs text-slate-400 uppercase">Exámenes</div></div>
                          </div>
                          <div className="glass-panel p-4 rounded-xl flex items-center gap-4">
                              <div className="p-3 bg-green-500/20 rounded-full text-green-400"><BarChart3/></div>
                              <div><div className="text-2xl font-bold text-white">{stats.avgScore.toFixed(1)}</div><div className="text-xs text-slate-400 uppercase">Puntuación Media</div></div>
                          </div>
                          <div className="glass-panel p-4 rounded-xl flex items-center gap-4">
                              <div className="p-3 bg-purple-500/20 rounded-full text-purple-400"><CheckCircle/></div>
                              <div><div className="text-2xl font-bold text-white">{stats.avgPct.toFixed(1)}%</div><div className="text-xs text-slate-400 uppercase">% Acierto Medio</div></div>
                          </div>
                      </div>
                  )}

                  <div className="bg-slate-900/50 border border-slate-800 rounded-xl overflow-hidden flex-1 relative">
                      <div className="absolute inset-0 overflow-y-auto">
                          <table className="w-full text-left">
                              <thead className="bg-slate-800 text-slate-400 text-xs uppercase sticky top-0 z-10">
                                  <tr>
                                      <th className="p-4">Fecha</th>
                                      <th className="p-4">Materia</th>
                                      <th className="p-4 text-center">Puntos</th>
                                      <th className="p-4 text-center">Nota %</th>
                                      <th className="p-4 text-right">Detalle (A/F/O)</th>
                                  </tr>
                              </thead>
                              <tbody className="divide-y divide-slate-800 text-slate-300">
                                  {results.map((r, i) => (
                                      <tr key={i} className="hover:bg-slate-800/30">
                                          <td className="p-4 text-sm font-mono">{new Date(r.date).toLocaleDateString()} <span className="text-slate-500">{new Date(r.date).toLocaleTimeString()}</span></td>
                                          <td className="p-4 font-bold text-white">{r.subjectName}</td>
                                          <td className="p-4 text-center font-bold text-blue-400">{r.score.toFixed(1)}</td>
                                          <td className="p-4 text-center">
                                              <span className={`px-2 py-1 rounded text-xs font-bold ${r.percentage >= 50 ? 'bg-green-900/30 text-green-400' : 'bg-red-900/30 text-red-400'}`}>
                                                  {r.percentage.toFixed(1)}%
                                              </span>
                                          </td>
                                          <td className="p-4 text-right text-xs font-mono">
                                              <span className="text-green-400">{r.hits}</span> / <span className="text-red-400">{r.misses}</span> / <span className="text-blue-400">{r.skips}</span>
                                          </td>
                                      </tr>
                                  ))}
                                  {results.length === 0 && (
                                      <tr><td colSpan="5" className="p-8 text-center text-slate-500 italic">No hay exámenes registrados.</td></tr>
                                  )}
                              </tbody>
                          </table>
                      </div>
                  </div>
              </div>
          );
      };

      // --- APP PRINCIPAL ---
      const App = () => {
          const [activeTab, setActiveTab] = useState('subjects');
          const [subjects, setSubjects] = usePersistentState('boardinggate_subjects', []);
          const [activeSubjectId, setActiveSubjectId] = usePersistentState('boardinggate_active_sub', null);
          const [history, setHistory] = usePersistentState('boardinggate_history', []);

          const activeSubject = subjects.find(s => s.id === activeSubjectId);

          const handleSaveResult = (result) => {
              setHistory(prev => [result, ...prev]);
              setActiveTab('history'); // Ir al historial al acabar
          };

          return (
              <div className="h-screen flex flex-col bg-[#0a0a0a] text-white">
                  {/* NAVBAR */}
                  <header className="shrink-0 bg-slate-900 border-b border-slate-800 px-6 py-4 flex justify-between items-center shadow-2xl z-20">
                      <div>
                          <h1 className="text-2xl md:text-3xl font-display font-bold tracking-tight">
                              <span className="bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">Boarding</span><span className="text-blue-600">Gate</span>
                          </h1>
                          <p className="text-[10px] text-slate-400 uppercase tracking-[0.2em] font-bold">Simulador Oposiciones AI</p>
                      </div>
                      
                      <nav className="flex bg-slate-800 rounded-lg p-1 gap-1">
                          <button onClick={() => setActiveTab('subjects')} className={`px-4 py-2 rounded-md text-xs font-bold uppercase transition-all flex items-center gap-2 ${activeTab === 'subjects' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                              <BookOpen size={16}/> <span className="hidden md:inline">Materias</span>
                          </button>
                          <button onClick={() => setActiveTab('exam')} className={`px-4 py-2 rounded-md text-xs font-bold uppercase transition-all flex items-center gap-2 ${activeTab === 'exam' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                              <Play size={16}/> <span className="hidden md:inline">Examen</span>
                          </button>
                          <button onClick={() => setActiveTab('history')} className={`px-4 py-2 rounded-md text-xs font-bold uppercase transition-all flex items-center gap-2 ${activeTab === 'history' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                              <Clock size={16}/> <span className="hidden md:inline">Histórico</span>
                          </button>
                          <button onClick={() => setActiveTab('settings')} className={`px-4 py-2 rounded-md text-xs font-bold uppercase transition-all flex items-center gap-2 ${activeTab === 'settings' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>
                              <Settings size={16}/> <span className="hidden md:inline">Config</span>
                          </button>
                      </nav>
                  </header>

                  {/* CONTENT AREA */}
                  <main className="flex-1 overflow-hidden relative">
                      {activeTab === 'subjects' && (
                          <SubjectsTab 
                              subjects={subjects} 
                              setSubjects={setSubjects} 
                              activeSubjectId={activeSubjectId} 
                              setActiveSubjectId={setActiveSubjectId} 
                          />
                      )}
                      
                      {activeTab === 'exam' && (
                          <ExamTab 
                              activeSubject={activeSubject}
                              onSaveResult={handleSaveResult}
                          />
                      )}

                      {activeTab === 'history' && (
                          <HistoryTab 
                              results={history} 
                              onClear={() => setHistory([])} 
                          />
                      )}

                      {activeTab === 'settings' && <SettingsTab />}
                  </main>
              </div>
          );
      };

      const root = createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
</body>
</html>
